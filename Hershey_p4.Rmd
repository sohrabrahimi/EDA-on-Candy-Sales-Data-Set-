---
title: "P4_Hershey"
author: "Sohrab Rahimi"
date: "January 15, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Motivation

In this project I will explore a candy sale data set. This data includes infomation about the candy sale for 1253  markets in four major cities (i.e. Philadelphia, Boston, DC and Pittsburgh) for 31 types of chocolate. The geographic information about the markets are also included. 

I will try to answer the following questions in this project: 

1- Which Brands sell more and in which cities?
2- Which zipcodes consume more candy on average? 
3- which markets sell more candies and what kinds of candies?
4- Which candies are more likely to be sold together? 
5- How different markets compare together interms of their candy sales?
6- What parts of the city consume more chocolate? how different neighborhoods compare in terms of their chocolate consumption? 


First we load all the required packages into R: 
```{r Hershey, results='hide', message=FALSE, warning=FALSE}
library(ggplot2)
library(ggthemes)
library(dplyr)
library(tidyr)
library(psych)
library(arules)
library(arulesViz)
library(gridExtra)
library(reshape2)
library(Hmisc)
library(corrplot)
library(data.table)
library(lattice)
library(ggmap)
library(SNFtool)
data = read.csv("C:/Users/sur216/Desktop/P4_udacity/CANDIES_STORES.csv",header = T)
data = data[,-1]
```


The data includes 1253 rows each representing one store. For each store the sales data for 31 brands of chocolate has been provided. 
```{r data}
names(data)
dim(data)
head(data)
```

## which markets sell more candies and what kinds of candies?

In order to get a sense of the candy sales in each city I will first create a "TOTAL" column where I add the sales for all types of candy for each market. Based on the plot below we can see that the target store sells highest in all except for Philadelphia. For Philadelphia alone, BJs wholesale club is slightly more than target on average. 

```{r city store, fig.width=12, fig.height=12}
data$TOTAL = rowSums(data[,c(6:36)])

candy_by_store = data %>% 
  group_by(STORE,CITY) %>% 
  summarise (sales_mean = mean(TOTAL),
             sales_median = median(TOTAL), 
             sales_sum = sum(TOTAL), n = n()) 

ggplot(aes(x = reorder(STORE,-sales_mean),  y= sales_mean), data = candy_by_store)+
  geom_bar(aes(fill = factor(CITY)),stat="identity",
           position = "dodge",width=.5,color=I('black')) + 
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))

```

# Which Brands sell more and in which cities?

Now let's convert the data to long format so that we can analyse each brand same as we did for each store. the plot below indicates how different brands compare in different cities. We can see that "Reese" is successful in all 4 cities.Some cities are specifically higher than others in some brands. For example, Hershey's Chocolate Assortment is significantly higher in Boston and DC. KitKat and Cadbury are highest in Boston while Philadelphia is more successful in Reese and Kisses. 

```{r brands, fig.width=12, fig.height=12}
data_long = melt(data,id.vars = c("STORE","LONG","LAT","ZIP.CODE","CITY","TOTAL"))
colnames(data_long)[7] <- "BRAND"
colnames(data_long)[8] <- "BRAND.SALE"
names(data_long)


p1<- ggplot(aes(x = BRAND,  y= BRAND.SALE), data = data_long) +
  stat_summary(aes(fill = factor(CITY)),colour = "black",fun.y=mean, geom="bar",
               position=position_dodge(0.6), width = 0.8, alpha = 0.7)+   
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))+
  xlab("Candy Brand")+ylab("Mean Brand Sale")+labs(title = "Mean Sale for Different Brands and Cities")+
  scale_fill_discrete(guide = guide_legend(title = "CITY"))

p2<- ggplot(aes(x = BRAND,  y= BRAND.SALE), data = data_long) +
  stat_summary(aes(fill = factor(CITY)),colour = "black",fun.y=median, geom="bar",
               position=position_dodge(0.6), width = 0.8, alpha = 0.7)+   
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))+
  xlab("Candy Brand")+ylab("Median Brand Sale")+labs(title = "Median Sale for Different Brands and Cities")+
  scale_fill_discrete(guide = guide_legend(title = "CITY"))

grid.arrange(p1,p2,ncol = 1)
```

# Which zip codes consume more candy on average?
We can now check the zip codes to see which ones sell more candies. I use the Census 2010 population data to normalize the candy sales on population. I found that three zipcodes are extremely higher than others so I removed them (i.e. "19112","19372","2199"). 
```{r zipcodes, fig.width=18, fig.height=8}

zipcode_pop = read.csv("C:/Users/sur216/Desktop/P4_udacity/Zipcode-pop.csv",header = T)
colnames(zipcode_pop)[1]<- "ZIP.CODE"
candy_by_zipcode = data %>% 
  group_by(ZIP.CODE,CITY) %>% 
  summarise (sales_mean = mean(TOTAL),
             sales_median = median(TOTAL), 
             sales_sum = sum(TOTAL), n = n()) 


candy_by_zipcode=merge(candy_by_zipcode,zipcode_pop,by = "ZIP.CODE")
candy_by_zipcode = candy_by_zipcode[,-8]


ggplot(aes(x =reorder(as.character(ZIP.CODE),-sales_sum/X2010.Population),  
           y= sales_sum/X2010.Population), data =candy_by_zipcode[!candy_by_zipcode$ZIP.CODE%in%c("19112","19372","2199"),]) + 
geom_bar(aes(fill = factor(CITY)),colour = 'black', stat = "identity") +   
theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.3)) + 
facet_wrap(~CITY, scales = "free", ncol = 1)+
scale_fill_discrete(guide = guide_legend(title = "CITY"))+
  xlab("Zip Code")+ylab("Per Capita Candy Sale")+labs(title = "Per Capita Candy Sale in Different Zip Codes")
```

Now we can run a regression to examin the relationship between zipcode population and candy sale. It make sense to have higher candy consumption in zipcodes with higher populations. I will use the log-log transformation since the raw data will give us a fan-shaped scatter plot. 

```{r regression, fig.width=12, fig.height=6}

candy_fit = lm(sales_sum~X2010.Population, data = candy_by_zipcode)
summary(candy_fit)

candy_zip_trans = transform(candy_by_zipcode,log_pop = log(X2010.Population), log_sum = log(sales_sum))

ggplot(aes(x=log_pop, y =log_sum), data = candy_zip_trans)+ geom_point(aes(colour = CITY, size = sales_median))+geom_smooth(method = 'lm', formula = y~x)
```

# Which brands sell together?

e first look into the simple correlations between different brands. we should use the wide format for correlations. As the correlation suggests, KitKat, Kisses, Reese, Cadbury, and Rolo are strongly correlated. The scatter plot is ordered through a hierarchial clustering and shows a number of interesting clusters.  

```{r correlation, fig.width=12, fig.height=12, , warning=FALSE}

candies = data[,c(6:12,14:26,28:36)]
names(candies)
corr_candies = cor(candies)
corrplot(corr_candies, order = "hclust")
```


# How different markets compare together in terms of their candy sales?

To compare different markets in terms of their candy sale, I will first define a function to calculate the cosine similarity for us. The function below takes the data as matrix and returns a cosine similarity matrix. 

```{r define_cosine, fig.width=12, fig.height=12, , warning=FALSE}

cosine <- function( x, y=NULL ) {

  if ( is.matrix(x) && is.null(y) ) {

    co = array(0,c(ncol(x),ncol(x)))
    f = colnames( x )
    dimnames(co) = list(f,f)

    for (i in 2:ncol(x)) {
      for (j in 1:(i-1)) {
        co[i,j] = cosine(x[,i], x[,j])
      }
    }
    co = co + t(co)
    diag(co) = 1

    return (as.matrix(co))

  } else if ( is.vector(x) && is.vector(y) ) {
    return ( crossprod(x,y) / sqrt( crossprod(x)*crossprod(y) ) )
  } else {
    stop("Error: input should be either a matrix or two vectors")
  }

}

```
Now we will apply this function to find the pairwise similarity matrix for markets. Using the levelplot() function we can visualiza this matrix in form of a heat map. we can now see interesting patterns in the heat map. for example, Target stores are distant from the BJs Wholesale Clubs and similar to Giant stores in terms of their candy sale. 
```{r similarity_markets, fig.width=12, fig.height=12, , warning=FALSE}

store_candies = cbind(data$STORE,candies)
names(store_candies)[1]<- "STORE"

stores <- store_candies %>%
group_by(STORE) %>%
  summarise_each(funs(mean))

stores = as.data.frame(stores)
rownames(stores)<- stores[,1]
stores_t = as.data.frame(t(stores)[-1,])

stores_t[is.na(stores_t)] <- 0
rownames(stores_t)<-c()

mat_stores = data.matrix(stores_t)
sim_stores = cosine(mat_stores,y=NULL)

new.palette=colorRampPalette(c("black","red","yellow","white"),space="rgb")

levelplot(sim_stores,col.regions=new.palette(20),scales=list(y=list(rot=0), x=list(rot=90)))
```

# How different neighborhoods compare in terms of candy consumption? 

Another interesting question to answer would be the geographical aspect of the markets. For each market we have the latitude and longitude data. We will use the ggmap() function to and assign colors to the stores to see which ones sell more. It looks like stores in the periphery are more successful in general. 

```{r maps_city, fig.width=13, fig.height=13, , warning=FALSE, message=FALSE}

phil <- get_map(location = "philadelphia",zoom = 11, source = "google", color = c("bw"))
bos  <- get_map(location = "boston",zoom = 12, source = "google", color = c("bw"))
dc  <- get_map(location = "washington dc",zoom = 12, source = "google", color = c("bw"))
pit  <- get_map(location = "pittsburgh",zoom = 11, source = "google", color = c("bw"))

p1<- ggmap(dc)+ geom_point(data = data, 
     aes(x=LONG, y=LAT, colour = log(TOTAL), size =TOTAL ))+ 
  scale_colour_gradient(limits=c(8, 12.72), low="red", high="green")+ 
  scale_size_continuous (name = c("Total Sale"))

p2<- ggmap(bos)+ geom_point(data = data, 
     aes(x=LONG, y=LAT, colour = log(TOTAL), size =TOTAL ))+ 
  scale_colour_gradient(limits=c(8, 12.73), low="red", high="green")+ 
  scale_size_continuous (name = c("Total Sale"))

p3<- ggmap(phil)+ geom_point(data = data, 
     aes(x=LONG, y=LAT, colour = log(TOTAL), size =TOTAL ))+ 
  scale_colour_gradient(limits=c(8, 12.73), low="red", high="green")+ 
  scale_size_continuous (name = c("Total Sale"))

p4<- ggmap(pit)+ geom_point(data = data, 
     aes(x=LONG, y=LAT, colour = log(TOTAL), size =TOTAL ))+ 
  scale_colour_gradient(limits=c(8, 12.73), low="red", high="green")+ 
  scale_size_continuous (name = c("Total Sale"))
  
grid.arrange(p1,p2,p3,p4,ncol = 2)
```

A more advanced way of going about the geographic aspect of the candy consumption is to find clusters of similar stores. That is, we first calculate a similarity matrix with the function that I previously define and then find clusters using spectral clustering. Doing so for Philadelphia, we can clearly see that there is a clear spatial pattern with downtown and suburbia being almost the same and the neighborhoods between them following another candy consumption patter. 

```{r phily clusters, fig.width=12, fig.height=12, , warning=FALSE}


#spectral clustering for Phily
candies_phily = data.matrix(t(candies[data$CITY == "Philadelphia",]))
sim_phily = cosine(candies_phily, y=NULL)
sc_phily<- spectralClustering(sim_phily, 3, type = 3)
phily_markets_SC = cbind(sc_phily,data[data$CITY == "Philadelphia",c("LONG","LAT")])

ggmap(phil) + 
  geom_point(data = phily_markets_SC, 
             aes(x=LONG, y=LAT, colour = factor(sc_phily)))

```

# Final plots and summary

In this section I will select the three most informative plots that I hjave made through out the course of exploratory data analysis on the candy data. First, the bar plot for each market plotted below indicates that the target is highest on average in both median values and mean values for all 4 citiesExcept for Philadelphia, as explained earlier.  

```{r citystore_clean, fig.width=12, fig.height=12}
data$TOTAL = rowSums(data[,c(6:36)])

candy_by_store = data %>% 
  group_by(STORE,CITY) %>% 
  summarise (sales_mean = mean(TOTAL),
             sales_median = median(TOTAL), 
             sales_sum = sum(TOTAL), n = n()) 

p1<- ggplot(aes(x = reorder(STORE,-sales_mean),  y= sales_mean), data = candy_by_store)+
  geom_bar(aes(fill = factor(CITY)),stat="identity",
           position = "dodge",width=.5, alpha = 0.8,color=I('black')) + 
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))+
  xlab("STORES")+
  ylab("Mean Candy Sale")+
  labs(title = "Mean Candy Sale for Different Stores and Cities")+
  scale_fill_discrete(guide = guide_legend(title = "CITY")) 

p2<- ggplot(aes(x = reorder(STORE,-sales_median),  y= sales_median), data = candy_by_store)+
  geom_bar(aes(fill = factor(CITY)),stat="identity",
           position = "dodge",width=.5, alpha = 0.8,color=I('black')) + 
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))+
  xlab("STORES")+
  ylab("Median Candy Sale")+
  labs(title = "Median Candy Sale for Different Stores and Cities")+
  scale_fill_discrete(guide = guide_legend(title = "CITY")) 

grid.arrange(p1,p2,ncol = 1)
```


For the regression, we limit the x axis to see the bulk of the data more clearly. we assign node size to the points which corresponds with the median sales in stores. We can now clearly see that there is a positive linear association between the log population and log candy sales in zipcodes.

```{r regression_clean, fig.width=12, fig.height=6}

candy_fit = lm(sales_sum~X2010.Population, data = candy_by_zipcode)

candy_zip_trans = transform(candy_by_zipcode,log_pop = log(X2010.Population), log_sum = log(sales_sum))

ggplot(aes(x=log_pop, y =log_sum), data = candy_zip_trans)+ geom_point(aes(colour = CITY, size = sales_median), alpha = 0.7)+ scale_color_brewer(palette="Set1")+
  geom_smooth(method = 'lm', formula = y~x)+ coord_cartesian(xlim = c(7, 11))+
    scale_size_continuous (name = "MEDIAN")+
  xlab("Population (Log Scale)")+ylab("Total Candy Sale (Log Scale)")+labs(title = "The Relationship between population and candy sale in different zip codes")
```


At last, we apply the spectral clustering method to all four cities to investigate patterns of chocolate use in the city. We can see that washington can be divided into two part, the east and west. Recall that washington is also racially divided in this manner. Philadelphia also has this clear spatial clusters. For Pittsburgh, it seems that the neighborhoods are not as distinct, however some clear green points can be seen closer to the center. Boston as well shows some similarity in candy consumption in south and west. 

```{r maps_clusters, fig.width=16, fig.height=16, , warning=FALSE}

#spectral clustering for Pittsburgh
candies_pitt = data.matrix(t(candies[data$CITY == "Pittsburgh",]))
sim_pitt = cosine(candies_pitt, y=NULL)
sc_pitt<- spectralClustering(sim_pitt, 3, type = 3)
pitt_markets_SC = cbind(sc_pitt,data[data$CITY == "Pittsburgh",c("LONG","LAT")])

#spectral clustering for DC
candies_dc = data.matrix(t(candies[data$CITY == "Washington",]))
sim_dc = cosine(candies_dc, y=NULL)
sc_dc<- spectralClustering(sim_dc, 3, type = 3)
dc_markets_SC = cbind(sc_dc,data[data$CITY == "Washington",c("LONG","LAT")])

#spectral clustering for Boston
candies_bos = data.matrix(t(candies[data$CITY == "Boston",]))
sim_bos = cosine(candies_bos, y=NULL)
sc_bos<- spectralClustering(sim_bos, 3, type = 3)
bos_markets_SC = cbind(sc_bos,data[data$CITY == "Boston",c("LONG","LAT")])

p1<- ggmap(phil) + 
  geom_point(data = phily_markets_SC, 
             aes(x=LONG, y=LAT, colour = factor(sc_phily),size = 0.7, alpha = 0.5))+
   guides(alpha=FALSE,size = FALSE)+scale_colour_discrete(name = "Clusters of Stores")+
   labs(title = "Clusters derivied from the similarity of stores in Philadelphia", size=2.5)
  

p2<- ggmap(pit) + 
  geom_point(data = pitt_markets_SC, 
             aes(x=LONG, y=LAT, colour = factor(sc_pitt),size = 0.7, alpha = 0.5))+
   guides(alpha=FALSE,size = FALSE)+scale_colour_discrete(name = "Clusters of Stores")+
   labs(title = "Clusters derivied from the similarity of stores in Pittsburgh", size=2.5)

p3<- ggmap(dc) + 
  geom_point(data = dc_markets_SC, 
             aes(x=LONG, y=LAT, colour = factor(sc_dc),size = 0.7, alpha = 0.5))+
   guides(alpha=FALSE,size = FALSE)+scale_colour_discrete(name = "Clusters of Stores")+
   labs(title = "Clusters derivied from the similarity of stores in Washington DC", size=2.5)

p4<- ggmap(bos) + 
  geom_point(data = bos_markets_SC, 
             aes(x=LONG, y=LAT, colour = factor(sc_bos),size = 0.7, alpha = 0.5))+
   guides(alpha=FALSE,size = FALSE)+
   scale_colour_discrete(name = "Clusters of Stores")+
   labs(title = "Clusters derivied from the similarity of stores in Boston", size=2.5)

grid.arrange(p1,p2,p3,p4,ncol = 2)

```

# Reflection

Our data analysis revewled some interesting patterns in the candy consumption data set. We found out which markets are more likely to sell more candy, We calos learnt how different brands compare in different cities. More importantly, we found out about cities and neighborhoods in each city. We found that there are clear candy consumption patterns in the four cities that we focused on. 

At the same time, thhere were a number of limitations that cannot be neglected. First, the number of data points for DC and Boston were significantly lower than the two other. This made it harder for a comprehensive comparison between the four cities. Also, There were a number of candies that were not included in the dataset that coule inform more about the tastes in different cities and neighborhoods and improve our clusterings. Future work can take the zip code demographic data into consideration and investigate the associations between different factors such as income, racial composition and etc. 